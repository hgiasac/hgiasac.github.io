<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Shared API Gateway (2017-11-11)</title><meta property="og:title" content="Shared API Gateway (2017-11-11)"/><meta property="twitter:title" content="Shared API Gateway (2017-11-11)"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,500"/><link rel="stylesheet" href="/assets/main.min.css"/><link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome-font-awesome.min.css"/></head><meta name="description" content="As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. If you design backend system in microservices, there is really painful. Imagine that there are 10 API Gateways for 1 application..."/><meta property="og:description" content="As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. If you design backend system in microservices, there is really painful. Imagine that there are 10 API Gateways for 1 application..."/><meta property="twitter:description" content="As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. If you design backend system in microservices, there is really painful. Imagine that there are 10 API Gateways for 1 application..."/><body><header><div class="container grid-lg"><nav class="horizontal main-nav"><ul><li><a href="/">Home</a></li><li><a href="/posts">Posts</a></li><li><a href="/about.html">About</a></li><li><a href="https://www.visualcv.com/toan-nguyen">CV</a></li></ul></nav></div></header><section class="section"><div id="main"><div class="wrapper"><div class="container grid-lg"><hr class="mt-2"/><article class="article"><h1 id="Share_AWS_API_Gateway_Resources_in_Serverless_Framework">Share AWS API Gateway Resources in Serverless Framework</h1><p>As your application grows, you will likely need to break it out into multiple, smaller services. By default, each Serverless project generates a new API Gateway. If you design backend system in microservices, there is really painful. Imagine that there are 10 API Gateways for 1 application. It is painful to monitor and increase the cost </p><p>By the time I writed this article, <a href="https://serverless.com">Serverless</a> didn&#39;t support shared API Gateway. There is a <a href="https://github.com/serverless/serverless/pull/3934">Pull Request</a> for this. However, it is so simple and limited that don&#39;t fit my needs. The critical point is, for example, I have a path <code>&#x2F;users</code> in service A, and I want to define a subpath <code>&#x2F;user&#x2F;{id}&#x2F;jobs</code> in service B. This PR don&#39;t work. So I decide to do <a href="https://github.com/serverless/serverless/pull/4247">another PR for this feature</a></p><blockquote><p>Update Jan 2018: This PR was merged. You can officially use it from version 1.26.0
Update May 2018: Share Authorizer PR was marge</p></blockquote><h2 id="Serverless_Template">Serverless Template</h2><p>You can share the same API Gateway between multiple projects by referencing its REST API ID and Root Resource ID in <code>serverless.yml</code> as follows:</p><pre class="code" data-lang="yml"><code>service: service-name<br/>provider:<br/>  name: aws<br/>  apiGateway:<br/>    restApiId: xxxxxxxxxx # REST API resource ID. Default is generated by the framework<br/>    restApiRootResourceId: xxxxxxxxxx # Root resource, represent as &#x2F; path<br/><br/>functions:<br/>  ...<br/></code></pre><p>If your application has many nested paths, you might also want to break them out into smaller services. </p><pre class="code" data-lang="yml"><code>service: service-a<br/>provider:<br/>  apiGateway:<br/>    restApiId: xxxxxxxxxx<br/>    restApiRootResourceId: xxxxxxxxxx<br/><br/>functions:<br/>  create:<br/>    handler: posts.create<br/>    events:<br/>      - http:<br/>          method: post<br/>          path: &#x2F;posts</code></pre><pre class="code" data-lang="yml"><code>service: service-b<br/>provider:<br/>  apiGateway:<br/>    restApiId: xxxxxxxxxx<br/>    restApiRootResourceId: xxxxxxxxxx<br/><br/>functions:<br/>  create:<br/>    handler: posts.createComment<br/>    events:<br/>      - http:<br/>          method: post<br/>          path: &#x2F;posts&#x2F;{id}&#x2F;comments</code></pre><p>The above example services both reference the same parent path <code>&#x2F;posts</code>. However, Cloudformation will throw an error if we try to generate an existing path resource. To avoid that, we reference the resource ID of <code>&#x2F;posts</code>:</p><pre class="code" data-lang="yml"><code>service: service-a<br/>provider:<br/>  apiGateway:<br/>    restApiId: xxxxxxxxxx<br/>    restApiRootResourceId: xxxxxxxxxx<br/>    restApiResources:<br/>      &#x2F;posts: xxxxxxxxxx<br/><br/>functions:<br/>  ...<br/></code></pre><pre class="code" data-lang="yml"><code>service: service-b<br/>provider:<br/>  apiGateway:<br/>    restApiId: xxxxxxxxxx<br/>    restApiRootResourceId: xxxxxxxxxx<br/>    restApiResources:<br/>      &#x2F;posts: xxxxxxxxxx<br/><br/>functions:<br/>  ...<br/></code></pre><p>You can define more than one path resource, but by default, Serverless will generate them from the root resource.
<code>restApiRootResourceId</code> is optional if a path resource isn&#39;t required for the root (<code>&#x2F;</code>).</p><pre class="code" data-lang="yml"><code>service: service-a<br/>provider:<br/>  apiGateway:<br/>    restApiId: xxxxxxxxxx<br/>    # restApiRootResourceId: xxxxxxxxxx # Optional<br/>    restApiResources:<br/>      &#x2F;posts: xxxxxxxxxx<br/>      &#x2F;categories: xxxxxxxxx<br/><br/><br/>functions:<br/>  listPosts:<br/>    handler: posts.list<br/>    events:<br/>      - http:<br/>          method: get<br/>          path: &#x2F;posts<br/><br/>  listCategories:<br/>    handler: categories.list<br/>    events:<br/>      - http:<br/>          method: get<br/>          path: &#x2F;categories<br/></code></pre><h3 id="Manually_Configuring_shared_API_Gateway_">Manually Configuring shared API Gateway </h3><p>Use AWS console on browser, navigate to the API Gateway console. Select your already existing API Gateway.
Top Navbar should look like this</p><pre class="code" data-lang=""><code>    APIs&gt;apigateway-Name (xxxxxxxxxx)&gt;Resources&gt;&#x2F; (yyyyyyyyyy)</code></pre><p>Here xxxxxxxxx is your restApiId and yyyyyyyyyy the restApiRootResourceId.</p><h4 id="Note_while_using_authorizers_with_shared_API_Gateway">Note while using authorizers with shared API Gateway</h4><p>AWS API Gateway allows only 1 Authorizer for 1 ARN, This is okay when you use conventional serverless setup, because each stage and service will create different API Gateway. But this can cause problem when using authorizers with shared API Gateway. If we use the same authorizer directly in different services like this. </p><pre class="code" data-lang="yml"><code>service: service-c<br/><br/>provider:<br/>  apiGateway:<br/>    restApiId:<br/>      &#39;Fn::ImportValue&#39;: apiGateway-restApiId<br/>    restApiRootResourceId:<br/>      &#39;Fn::ImportValue&#39;: apiGateway-rootResourceId<br/><br/>functions:<br/>  deleteUser:<br/>    events:<br/>      - http:<br/>        path: &#x2F;users&#x2F;{userId}<br/>        authorizer:<br/>          arn: xxxxxxxxxxxxxxxxx #cognito&#x2F;custom authorizer arn </code></pre><pre class="code" data-lang="yml"><code>service: service-d<br/><br/>provider:<br/>  apiGateway:<br/>    restApiId:<br/>      &#39;Fn::ImportValue&#39;: apiGateway-restApiId<br/>    restApiRootResourceId:<br/>      &#39;Fn::ImportValue&#39;: apiGateway-rootResourceId<br/><br/>functions:<br/>  deleteProject:<br/>    events:<br/>      - http:<br/>        path: &#x2F;project&#x2F;{projectId}<br/>        authorizer:<br/>          arn: xxxxxxxxxxxxxxxxx #cognito&#x2F;custom authorizer arn </code></pre><p>we encounter error from cloudformation as reported <a href="https://github.com/serverless/serverless/issues/4711">here</a>.</p><p>A proper fix for this is work is using <a href="#share-authorizer">Share Authorizer</a> or you can add a unique <code>name</code> attribute to <code>authorizer</code> in each function. This creates different API Gateway authorizer for each function, bound to the same API Gateway. However, there is a limit of 10 authorizers per RestApi, and they are forced to contact AWS to request a limit increase to unblock development. </p><h2 id="Share_Authorizer">Share Authorizer</h2><p>Auto-created Authorizer is convenient for conventional setup. However, when you need to define your custom Authorizer, or use <code>COGNITO_USER_POOLS</code> authorizer with shared API Gateway, it is painful because of AWS limitation. Sharing Authorizer is a better way to do. </p><pre class="code" data-lang="yml"><code>functions:<br/>  createUser:<br/>     ...<br/>    events:<br/>      - http:<br/>          path: &#x2F;users<br/>          ...     <br/>          authorizer:<br/>            # Provide both type and authorizerId<br/>            type: COGNITO_USER_POOLS # TOKEN or COGNITO_USER_POOLS, same as AWS Cloudformation documentation<br/>            authorizerId: <br/>              Ref: ApiGatewayAuthorizer  # or hard-code Authorizer ID<br/><br/>  deleteUser:<br/>     ...<br/>    events:<br/>      - http:<br/>          path: &#x2F;users&#x2F;{userId}<br/>          ...     <br/>          # Provide both type and authorizerId<br/>          type: COGNITO_USER_POOLS # TOKEN or COGNITO_USER_POOLS, same as AWS Cloudformation documentation<br/>          authorizerId: <br/>            Ref: ApiGatewayAuthorizer # or hard-code Authorizer ID<br/><br/>resources:<br/>  Resources:<br/>    ApiGatewayAuthorizer: <br/>      Type: AWS::ApiGateway::Authorizer<br/>      Properties: <br/>        AuthorizerResultTtlInSeconds: 300<br/>        IdentitySource: method.request.header.Authorization<br/>        Name: Cognito<br/>        RestApiId: <br/>          Ref: YourApiGatewayName<br/>        Type: COGNITO_USER_POOLS<br/>        ProviderARNs: <br/>          - arn:aws:cognito-idp:${self:provider.region}:xxxxxx:userpool&#x2F;abcdef <br/>          </code></pre></article></div></div></div></section><footer><div class="wrapper"><div class="container grid-lg"><hr/><div class="text-center"><a class="secondary" href="https://github.com/hgiasac"><i class="fa fa-github fa-2x"> </i></a><a class="secondary" href="https://www.linkedin.com/in/toan-nguyen-83295527/"><i class="fa fa-linkedin fa-2x"> </i></a><a class="secondary" href="https://stackoverflow.com/users/4230985/hgiasac"><i class="fa fa-stack-overflow fa-2x"> </i></a></div><div class="text-center mt-2">© Toan Nguyen 2017-2021</div></div></div></footer></body></html>